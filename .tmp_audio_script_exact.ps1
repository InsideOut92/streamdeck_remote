
$ErrorActionPreference = 'Stop'
Set-StrictMode -Version Latest

if (-not ("StreamDeckAudio.CoreAudioBridge" -as [type])) {
  $code = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String('CnVzaW5nIFN5c3RlbTsKdXNpbmcgU3lzdGVtLkNvbGxlY3Rpb25zLkdlbmVyaWM7CnVzaW5nIFN5c3RlbS5EaWFnbm9zdGljczsKdXNpbmcgU3lzdGVtLlJ1bnRpbWUuSW50ZXJvcFNlcnZpY2VzOwoKbmFtZXNwYWNlIFN0cmVhbURlY2tBdWRpbyB7CiAgcHVibGljIGVudW0gRURhdGFGbG93IHsgZVJlbmRlciA9IDAsIGVDYXB0dXJlID0gMSwgZUFsbCA9IDIgfQogIHB1YmxpYyBlbnVtIEVSb2xlIHsgZUNvbnNvbGUgPSAwLCBlTXVsdGltZWRpYSA9IDEsIGVDb21tdW5pY2F0aW9ucyA9IDIgfQogIHB1YmxpYyBlbnVtIEF1ZGlvU2Vzc2lvblN0YXRlIHsgSW5hY3RpdmUgPSAwLCBBY3RpdmUgPSAxLCBFeHBpcmVkID0gMiB9CgogIFtHdWlkKCJBOTU2NjREMi05NjE0LTRGMzUtQTc0Ni1ERThEQjYzNjE3RTYiKSwgSW50ZXJmYWNlVHlwZShDb21JbnRlcmZhY2VUeXBlLkludGVyZmFjZUlzSVVua25vd24pXQogIGludGVyZmFjZSBJTU1EZXZpY2VFbnVtZXJhdG9yIHsKICAgIGludCBOb3RJbXBsMSgpOwogICAgaW50IEdldERlZmF1bHRBdWRpb0VuZHBvaW50KEVEYXRhRmxvdyBkYXRhRmxvdywgRVJvbGUgcm9sZSwgb3V0IElNTURldmljZSBwcERldmljZSk7CiAgfQoKICBbR3VpZCgiRDY2NjA2M0YtMTU4Ny00RTQzLTgxRjEtQjk0OEU4MDczNjNGIiksIEludGVyZmFjZVR5cGUoQ29tSW50ZXJmYWNlVHlwZS5JbnRlcmZhY2VJc0lVbmtub3duKV0KICBpbnRlcmZhY2UgSU1NRGV2aWNlIHsKICAgIGludCBBY3RpdmF0ZShyZWYgR3VpZCBpaWQsIGludCBkd0Nsc0N0eCwgSW50UHRyIHBBY3RpdmF0aW9uUGFyYW1zLCBbTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuSVVua25vd24pXSBvdXQgb2JqZWN0IHBwSW50ZXJmYWNlKTsKICB9CgogIFtHdWlkKCI3N0FBOTlBMC0xQkQ2LTQ4NEYtOEJDNy0yQzY1NEM5QTlCNkYiKSwgSW50ZXJmYWNlVHlwZShDb21JbnRlcmZhY2VUeXBlLkludGVyZmFjZUlzSVVua25vd24pXQogIGludGVyZmFjZSBJQXVkaW9TZXNzaW9uTWFuYWdlcjIgewogICAgaW50IE5vdEltcGwxKCk7CiAgICBpbnQgTm90SW1wbDIoKTsKICAgIGludCBHZXRTZXNzaW9uRW51bWVyYXRvcihvdXQgSUF1ZGlvU2Vzc2lvbkVudW1lcmF0b3IgU2Vzc2lvbkVudW0pOwogIH0KCiAgW0d1aWQoIkUyRjVCQjExLTA1NzAtNDBDQS1BQ0RELTNBQTAxMjc3REVFOCIpLCBJbnRlcmZhY2VUeXBlKENvbUludGVyZmFjZVR5cGUuSW50ZXJmYWNlSXNJVW5rbm93bildCiAgaW50ZXJmYWNlIElBdWRpb1Nlc3Npb25FbnVtZXJhdG9yIHsKICAgIGludCBHZXRDb3VudChvdXQgaW50IFNlc3Npb25Db3VudCk7CiAgICBpbnQgR2V0U2Vzc2lvbihpbnQgU2Vzc2lvbkNvdW50LCBvdXQgSUF1ZGlvU2Vzc2lvbkNvbnRyb2wgU2Vzc2lvbik7CiAgfQoKICBbR3VpZCgiRjRCMUE1OTktNzI2Ni00MzE5LUE4Q0EtRTcwQUNCMTFFOENEIiksIEludGVyZmFjZVR5cGUoQ29tSW50ZXJmYWNlVHlwZS5JbnRlcmZhY2VJc0lVbmtub3duKV0KICBpbnRlcmZhY2UgSUF1ZGlvU2Vzc2lvbkNvbnRyb2wgewogICAgaW50IEdldFN0YXRlKG91dCBBdWRpb1Nlc3Npb25TdGF0ZSBwUmV0VmFsKTsKICAgIGludCBHZXREaXNwbGF5TmFtZShbTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuTFBXU3RyKV0gb3V0IHN0cmluZyBwUmV0VmFsKTsKICAgIGludCBTZXREaXNwbGF5TmFtZShbTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuTFBXU3RyKV0gc3RyaW5nIFZhbHVlLCByZWYgR3VpZCBFdmVudENvbnRleHQpOwogICAgaW50IEdldEljb25QYXRoKFtNYXJzaGFsQXMoVW5tYW5hZ2VkVHlwZS5MUFdTdHIpXSBvdXQgc3RyaW5nIHBSZXRWYWwpOwogICAgaW50IFNldEljb25QYXRoKFtNYXJzaGFsQXMoVW5tYW5hZ2VkVHlwZS5MUFdTdHIpXSBzdHJpbmcgVmFsdWUsIHJlZiBHdWlkIEV2ZW50Q29udGV4dCk7CiAgICBpbnQgR2V0R3JvdXBpbmdQYXJhbShvdXQgR3VpZCBwUmV0VmFsKTsKICAgIGludCBTZXRHcm91cGluZ1BhcmFtKHJlZiBHdWlkIE92ZXJyaWRlLCByZWYgR3VpZCBFdmVudENvbnRleHQpOwogICAgaW50IFJlZ2lzdGVyQXVkaW9TZXNzaW9uTm90aWZpY2F0aW9uKEludFB0ciBOZXdOb3RpZmljYXRpb25zKTsKICAgIGludCBVbnJlZ2lzdGVyQXVkaW9TZXNzaW9uTm90aWZpY2F0aW9uKEludFB0ciBOZXdOb3RpZmljYXRpb25zKTsKICB9CgogIFtHdWlkKCJiZmI3ZmY4OC03MjM5LTRmYzktOGZhMi0wN2M5NTBiZTljNmQiKSwgSW50ZXJmYWNlVHlwZShDb21JbnRlcmZhY2VUeXBlLkludGVyZmFjZUlzSVVua25vd24pXQogIGludGVyZmFjZSBJQXVkaW9TZXNzaW9uQ29udHJvbDIgewogICAgaW50IEdldFN0YXRlKG91dCBBdWRpb1Nlc3Npb25TdGF0ZSBwUmV0VmFsKTsKICAgIGludCBHZXREaXNwbGF5TmFtZShbTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuTFBXU3RyKV0gb3V0IHN0cmluZyBwUmV0VmFsKTsKICAgIGludCBTZXREaXNwbGF5TmFtZShbTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuTFBXU3RyKV0gc3RyaW5nIFZhbHVlLCByZWYgR3VpZCBFdmVudENvbnRleHQpOwogICAgaW50IEdldEljb25QYXRoKFtNYXJzaGFsQXMoVW5tYW5hZ2VkVHlwZS5MUFdTdHIpXSBvdXQgc3RyaW5nIHBSZXRWYWwpOwogICAgaW50IFNldEljb25QYXRoKFtNYXJzaGFsQXMoVW5tYW5hZ2VkVHlwZS5MUFdTdHIpXSBzdHJpbmcgVmFsdWUsIHJlZiBHdWlkIEV2ZW50Q29udGV4dCk7CiAgICBpbnQgR2V0R3JvdXBpbmdQYXJhbShvdXQgR3VpZCBwUmV0VmFsKTsKICAgIGludCBTZXRHcm91cGluZ1BhcmFtKHJlZiBHdWlkIE92ZXJyaWRlLCByZWYgR3VpZCBFdmVudENvbnRleHQpOwogICAgaW50IFJlZ2lzdGVyQXVkaW9TZXNzaW9uTm90aWZpY2F0aW9uKEludFB0ciBOZXdOb3RpZmljYXRpb25zKTsKICAgIGludCBVbnJlZ2lzdGVyQXVkaW9TZXNzaW9uTm90aWZpY2F0aW9uKEludFB0ciBOZXdOb3RpZmljYXRpb25zKTsKICAgIGludCBHZXRTZXNzaW9uSWRlbnRpZmllcihbTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuTFBXU3RyKV0gb3V0IHN0cmluZyBwUmV0VmFsKTsKICAgIGludCBHZXRTZXNzaW9uSW5zdGFuY2VJZGVudGlmaWVyKFtNYXJzaGFsQXMoVW5tYW5hZ2VkVHlwZS5MUFdTdHIpXSBvdXQgc3RyaW5nIHBSZXRWYWwpOwogICAgaW50IEdldFByb2Nlc3NJZChvdXQgdWludCBwUmV0VmFsKTsKICAgIGludCBJc1N5c3RlbVNvdW5kc1Nlc3Npb24oKTsKICAgIGludCBTZXREdWNraW5nUHJlZmVyZW5jZShib29sIG9wdE91dCk7CiAgfQoKICBbR3VpZCgiODdDRTU0OTgtNjhENi00NEU1LTkyMTUtNkRBNDdFRjg4M0Q4IiksIEludGVyZmFjZVR5cGUoQ29tSW50ZXJmYWNlVHlwZS5JbnRlcmZhY2VJc0lVbmtub3duKV0KICBpbnRlcmZhY2UgSVNpbXBsZUF1ZGlvVm9sdW1lIHsKICAgIGludCBTZXRNYXN0ZXJWb2x1bWUoZmxvYXQgZkxldmVsLCByZWYgR3VpZCBFdmVudENvbnRleHQpOwogICAgaW50IEdldE1hc3RlclZvbHVtZShvdXQgZmxvYXQgcGZMZXZlbCk7CiAgICBpbnQgU2V0TXV0ZShib29sIGJNdXRlLCByZWYgR3VpZCBFdmVudENvbnRleHQpOwogICAgaW50IEdldE11dGUob3V0IGJvb2wgcGJNdXRlKTsKICB9CgogIFtDb21JbXBvcnQsIEd1aWQoIkJDREUwMzk1LUU1MkYtNDY3Qy04RTNELUM0NTc5MjkxNjkyRSIpXQogIGNsYXNzIE1NRGV2aWNlRW51bWVyYXRvckNvbU9iamVjdCB7IH0KCiAgcHVibGljIHNlYWxlZCBjbGFzcyBTZXNzaW9uU25hcHNob3QgewogICAgcHVibGljIGludCBQaWQgeyBnZXQ7IHNldDsgfQogICAgcHVibGljIHN0cmluZyBQcm9jZXNzTmFtZSB7IGdldDsgc2V0OyB9CiAgICBwdWJsaWMgc3RyaW5nIERpc3BsYXlOYW1lIHsgZ2V0OyBzZXQ7IH0KICAgIHB1YmxpYyBzdHJpbmcgU2Vzc2lvbklkZW50aWZpZXIgeyBnZXQ7IHNldDsgfQogICAgcHVibGljIHN0cmluZyBTdGF0ZSB7IGdldDsgc2V0OyB9CiAgICBwdWJsaWMgZG91YmxlIFZvbHVtZVBlcmNlbnQgeyBnZXQ7IHNldDsgfQogICAgcHVibGljIGJvb2wgTXV0ZWQgeyBnZXQ7IHNldDsgfQogICAgcHVibGljIGJvb2wgSGFzV2luZG93IHsgZ2V0OyBzZXQ7IH0KICB9CgogIHB1YmxpYyBzdGF0aWMgY2xhc3MgQ29yZUF1ZGlvQnJpZGdlIHsKICAgIGNvbnN0IGludCBDTFNDVFhfQUxMID0gMjM7CiAgICBjb25zdCB1aW50IFdNX0FQUENPTU1BTkQgPSAweDAzMTk7CiAgICBjb25zdCBpbnQgQVBQQ09NTUFORF9NRURJQV9QTEFZX1BBVVNFID0gMTQ7CiAgICBjb25zdCBieXRlIFZLX01FRElBX1BMQVlfUEFVU0UgPSAweEIzOwogICAgY29uc3QgaW50IEtFWUVWRU5URl9LRVlVUCA9IDB4MDAwMjsKCiAgICBbRGxsSW1wb3J0KCJ1c2VyMzIuZGxsIiwgU2V0TGFzdEVycm9yID0gdHJ1ZSldCiAgICBzdGF0aWMgZXh0ZXJuIGJvb2wgUG9zdE1lc3NhZ2UoSW50UHRyIGhXbmQsIHVpbnQgbXNnLCBJbnRQdHIgd1BhcmFtLCBJbnRQdHIgbFBhcmFtKTsKCiAgICBbRGxsSW1wb3J0KCJ1c2VyMzIuZGxsIildCiAgICBzdGF0aWMgZXh0ZXJuIHZvaWQga2V5YmRfZXZlbnQoYnl0ZSBiVmssIGJ5dGUgYlNjYW4sIGludCBkd0ZsYWdzLCBpbnQgZHdFeHRyYUluZm8pOwoKICAgIHN0YXRpYyBJQXVkaW9TZXNzaW9uRW51bWVyYXRvciBDcmVhdGVTZXNzaW9uRW51bWVyYXRvcigpIHsKICAgICAgSU1NRGV2aWNlRW51bWVyYXRvciBkZXZpY2VFbnVtZXJhdG9yID0gbmV3IE1NRGV2aWNlRW51bWVyYXRvckNvbU9iamVjdCgpIGFzIElNTURldmljZUVudW1lcmF0b3I7CiAgICAgIGlmIChkZXZpY2VFbnVtZXJhdG9yID09IG51bGwpIHRocm93IG5ldyBJbnZhbGlkT3BlcmF0aW9uRXhjZXB0aW9uKCJJTU1EZXZpY2VFbnVtZXJhdG9yIHVuYXZhaWxhYmxlIik7CgogICAgICBJTU1EZXZpY2UgZGV2aWNlOwogICAgICBNYXJzaGFsLlRocm93RXhjZXB0aW9uRm9ySFIoZGV2aWNlRW51bWVyYXRvci5HZXREZWZhdWx0QXVkaW9FbmRwb2ludChFRGF0YUZsb3cuZVJlbmRlciwgRVJvbGUuZU11bHRpbWVkaWEsIG91dCBkZXZpY2UpKTsKICAgICAgaWYgKGRldmljZSA9PSBudWxsKSB0aHJvdyBuZXcgSW52YWxpZE9wZXJhdGlvbkV4Y2VwdGlvbigiRGVmYXVsdCBhdWRpbyBlbmRwb2ludCB1bmF2YWlsYWJsZSIpOwoKICAgICAgb2JqZWN0IG1hbmFnZXJPYmo7CiAgICAgIEd1aWQgaWlkID0gdHlwZW9mKElBdWRpb1Nlc3Npb25NYW5hZ2VyMikuR1VJRDsKICAgICAgTWFyc2hhbC5UaHJvd0V4Y2VwdGlvbkZvckhSKGRldmljZS5BY3RpdmF0ZShyZWYgaWlkLCBDTFNDVFhfQUxMLCBJbnRQdHIuWmVybywgb3V0IG1hbmFnZXJPYmopKTsKICAgICAgSUF1ZGlvU2Vzc2lvbk1hbmFnZXIyIG1hbmFnZXIgPSBtYW5hZ2VyT2JqIGFzIElBdWRpb1Nlc3Npb25NYW5hZ2VyMjsKICAgICAgaWYgKG1hbmFnZXIgPT0gbnVsbCkgdGhyb3cgbmV3IEludmFsaWRPcGVyYXRpb25FeGNlcHRpb24oIklBdWRpb1Nlc3Npb25NYW5hZ2VyMiB1bmF2YWlsYWJsZSIpOwoKICAgICAgSUF1ZGlvU2Vzc2lvbkVudW1lcmF0b3IgZW51bWVyYXRvcjsKICAgICAgTWFyc2hhbC5UaHJvd0V4Y2VwdGlvbkZvckhSKG1hbmFnZXIuR2V0U2Vzc2lvbkVudW1lcmF0b3Iob3V0IGVudW1lcmF0b3IpKTsKICAgICAgcmV0dXJuIGVudW1lcmF0b3I7CiAgICB9CgogICAgcHVibGljIHN0YXRpYyBMaXN0PFNlc3Npb25TbmFwc2hvdD4gTGlzdFNlc3Npb25zKCkgewogICAgICBMaXN0PFNlc3Npb25TbmFwc2hvdD4gcmVzdWx0ID0gbmV3IExpc3Q8U2Vzc2lvblNuYXBzaG90PigpOwogICAgICBJQXVkaW9TZXNzaW9uRW51bWVyYXRvciBlbnVtZXJhdG9yID0gQ3JlYXRlU2Vzc2lvbkVudW1lcmF0b3IoKTsKICAgICAgaW50IGNvdW50ID0gMDsKICAgICAgTWFyc2hhbC5UaHJvd0V4Y2VwdGlvbkZvckhSKGVudW1lcmF0b3IuR2V0Q291bnQob3V0IGNvdW50KSk7CgogICAgICBmb3IgKGludCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgICBJQXVkaW9TZXNzaW9uQ29udHJvbCBjb250cm9sOwogICAgICAgIE1hcnNoYWwuVGhyb3dFeGNlcHRpb25Gb3JIUihlbnVtZXJhdG9yLkdldFNlc3Npb24oaSwgb3V0IGNvbnRyb2wpKTsKICAgICAgICBpZiAoY29udHJvbCA9PSBudWxsKSBjb250aW51ZTsKCiAgICAgICAgSUF1ZGlvU2Vzc2lvbkNvbnRyb2wyIGNvbnRyb2wyID0gY29udHJvbCBhcyBJQXVkaW9TZXNzaW9uQ29udHJvbDI7CiAgICAgICAgSVNpbXBsZUF1ZGlvVm9sdW1lIHZvbHVtZSA9IGNvbnRyb2wgYXMgSVNpbXBsZUF1ZGlvVm9sdW1lOwogICAgICAgIGlmIChjb250cm9sMiA9PSBudWxsIHx8IHZvbHVtZSA9PSBudWxsKSBjb250aW51ZTsKCiAgICAgICAgQXVkaW9TZXNzaW9uU3RhdGUgc3RhdGUgPSBBdWRpb1Nlc3Npb25TdGF0ZS5JbmFjdGl2ZTsKICAgICAgICB0cnkgeyBjb250cm9sLkdldFN0YXRlKG91dCBzdGF0ZSk7IH0gY2F0Y2ggeyB9CgogICAgICAgIHVpbnQgcGlkUmF3ID0gMDsKICAgICAgICB0cnkgeyBjb250cm9sMi5HZXRQcm9jZXNzSWQob3V0IHBpZFJhdyk7IH0gY2F0Y2ggeyB9CiAgICAgICAgaW50IHBpZCA9IHVuY2hlY2tlZCgoaW50KXBpZFJhdyk7CgogICAgICAgIHN0cmluZyBkaXNwbGF5TmFtZSA9ICIiOwogICAgICAgIHRyeSB7IGNvbnRyb2wuR2V0RGlzcGxheU5hbWUob3V0IGRpc3BsYXlOYW1lKTsgfSBjYXRjaCB7IGRpc3BsYXlOYW1lID0gIiI7IH0KCiAgICAgICAgc3RyaW5nIHNlc3Npb25JZGVudGlmaWVyID0gIiI7CiAgICAgICAgdHJ5IHsgY29udHJvbDIuR2V0U2Vzc2lvbklkZW50aWZpZXIob3V0IHNlc3Npb25JZGVudGlmaWVyKTsgfSBjYXRjaCB7IHNlc3Npb25JZGVudGlmaWVyID0gIiI7IH0KCiAgICAgICAgZmxvYXQgdm9sdW1lUmF3ID0gMGY7CiAgICAgICAgdHJ5IHsgdm9sdW1lLkdldE1hc3RlclZvbHVtZShvdXQgdm9sdW1lUmF3KTsgfSBjYXRjaCB7IH0KICAgICAgICBib29sIG11dGVkID0gZmFsc2U7CiAgICAgICAgdHJ5IHsgdm9sdW1lLkdldE11dGUob3V0IG11dGVkKTsgfSBjYXRjaCB7IH0KCiAgICAgICAgc3RyaW5nIHByb2Nlc3NOYW1lID0gIiI7CiAgICAgICAgYm9vbCBoYXNXaW5kb3cgPSBmYWxzZTsKICAgICAgICBpZiAocGlkID4gMCkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgUHJvY2VzcyBwcm9jZXNzID0gUHJvY2Vzcy5HZXRQcm9jZXNzQnlJZChwaWQpOwogICAgICAgICAgICBwcm9jZXNzTmFtZSA9IHByb2Nlc3MuUHJvY2Vzc05hbWUgPz8gIiI7CiAgICAgICAgICAgIGhhc1dpbmRvdyA9IHByb2Nlc3MuTWFpbldpbmRvd0hhbmRsZSAhPSBJbnRQdHIuWmVybzsKICAgICAgICAgIH0gY2F0Y2ggewogICAgICAgICAgICBwcm9jZXNzTmFtZSA9ICIiOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAocGlkID09IDApIHsKICAgICAgICAgIHByb2Nlc3NOYW1lID0gIlN5c3RlbSI7CiAgICAgICAgfQoKICAgICAgICByZXN1bHQuQWRkKG5ldyBTZXNzaW9uU25hcHNob3QgewogICAgICAgICAgUGlkID0gcGlkLAogICAgICAgICAgUHJvY2Vzc05hbWUgPSBwcm9jZXNzTmFtZSwKICAgICAgICAgIERpc3BsYXlOYW1lID0gZGlzcGxheU5hbWUgPz8gIiIsCiAgICAgICAgICBTZXNzaW9uSWRlbnRpZmllciA9IHNlc3Npb25JZGVudGlmaWVyID8/ICIiLAogICAgICAgICAgU3RhdGUgPSBzdGF0ZS5Ub1N0cmluZygpLAogICAgICAgICAgVm9sdW1lUGVyY2VudCA9IE1hdGguUm91bmQoTWF0aC5NYXgoMC4wLCBNYXRoLk1pbigxLjAsIHZvbHVtZVJhdykpICogMTAwLjAsIDEpLAogICAgICAgICAgTXV0ZWQgPSBtdXRlZCwKICAgICAgICAgIEhhc1dpbmRvdyA9IGhhc1dpbmRvdwogICAgICAgIH0pOwogICAgICB9CgogICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIHB1YmxpYyBzdGF0aWMgYm9vbCBTZXRWb2x1bWUoaW50IHBpZCwgZmxvYXQgbGV2ZWwsIG91dCBzdHJpbmcgbWVzc2FnZSkgewogICAgICBtZXNzYWdlID0gIiI7CiAgICAgIGlmIChwaWQgPD0gMCkgewogICAgICAgIG1lc3NhZ2UgPSAicGlkIGZlaGx0IjsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGZsb2F0IGNsYW1wZWQgPSBNYXRoLk1heCgwZiwgTWF0aC5NaW4oMWYsIGxldmVsKSk7CiAgICAgIEd1aWQgY29udGV4dCA9IEd1aWQuRW1wdHk7CiAgICAgIGludCBjaGFuZ2VkID0gMDsKICAgICAgSUF1ZGlvU2Vzc2lvbkVudW1lcmF0b3IgZW51bWVyYXRvciA9IENyZWF0ZVNlc3Npb25FbnVtZXJhdG9yKCk7CiAgICAgIGludCBjb3VudCA9IDA7CiAgICAgIE1hcnNoYWwuVGhyb3dFeGNlcHRpb25Gb3JIUihlbnVtZXJhdG9yLkdldENvdW50KG91dCBjb3VudCkpOwoKICAgICAgZm9yIChpbnQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgSUF1ZGlvU2Vzc2lvbkNvbnRyb2wgY29udHJvbDsKICAgICAgICBNYXJzaGFsLlRocm93RXhjZXB0aW9uRm9ySFIoZW51bWVyYXRvci5HZXRTZXNzaW9uKGksIG91dCBjb250cm9sKSk7CiAgICAgICAgaWYgKGNvbnRyb2wgPT0gbnVsbCkgY29udGludWU7CgogICAgICAgIElBdWRpb1Nlc3Npb25Db250cm9sMiBjb250cm9sMiA9IGNvbnRyb2wgYXMgSUF1ZGlvU2Vzc2lvbkNvbnRyb2wyOwogICAgICAgIElTaW1wbGVBdWRpb1ZvbHVtZSB2b2x1bWUgPSBjb250cm9sIGFzIElTaW1wbGVBdWRpb1ZvbHVtZTsKICAgICAgICBpZiAoY29udHJvbDIgPT0gbnVsbCB8fCB2b2x1bWUgPT0gbnVsbCkgY29udGludWU7CgogICAgICAgIHVpbnQgcGlkUmF3ID0gMDsKICAgICAgICB0cnkgeyBjb250cm9sMi5HZXRQcm9jZXNzSWQob3V0IHBpZFJhdyk7IH0gY2F0Y2ggeyB9CiAgICAgICAgaWYgKHVuY2hlY2tlZCgoaW50KXBpZFJhdykgIT0gcGlkKSBjb250aW51ZTsKICAgICAgICB2b2x1bWUuU2V0TWFzdGVyVm9sdW1lKGNsYW1wZWQsIHJlZiBjb250ZXh0KTsKICAgICAgICBjaGFuZ2VkKys7CiAgICAgIH0KCiAgICAgIGlmIChjaGFuZ2VkIDw9IDApIHsKICAgICAgICBtZXNzYWdlID0gIktlaW5lIFNlc3Npb24gZnVlciBwaWQgZ2VmdW5kZW4iOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBtZXNzYWdlID0gIk9LIjsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgcHVibGljIHN0YXRpYyBib29sIFNldE11dGUoaW50IHBpZCwgYm9vbCBtdXRlLCBvdXQgc3RyaW5nIG1lc3NhZ2UpIHsKICAgICAgbWVzc2FnZSA9ICIiOwogICAgICBpZiAocGlkIDw9IDApIHsKICAgICAgICBtZXNzYWdlID0gInBpZCBmZWhsdCI7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICBHdWlkIGNvbnRleHQgPSBHdWlkLkVtcHR5OwogICAgICBpbnQgY2hhbmdlZCA9IDA7CiAgICAgIElBdWRpb1Nlc3Npb25FbnVtZXJhdG9yIGVudW1lcmF0b3IgPSBDcmVhdGVTZXNzaW9uRW51bWVyYXRvcigpOwogICAgICBpbnQgY291bnQgPSAwOwogICAgICBNYXJzaGFsLlRocm93RXhjZXB0aW9uRm9ySFIoZW51bWVyYXRvci5HZXRDb3VudChvdXQgY291bnQpKTsKCiAgICAgIGZvciAoaW50IGkgPSAwOyBpIDwgY291bnQ7IGkrKykgewogICAgICAgIElBdWRpb1Nlc3Npb25Db250cm9sIGNvbnRyb2w7CiAgICAgICAgTWFyc2hhbC5UaHJvd0V4Y2VwdGlvbkZvckhSKGVudW1lcmF0b3IuR2V0U2Vzc2lvbihpLCBvdXQgY29udHJvbCkpOwogICAgICAgIGlmIChjb250cm9sID09IG51bGwpIGNvbnRpbnVlOwoKICAgICAgICBJQXVkaW9TZXNzaW9uQ29udHJvbDIgY29udHJvbDIgPSBjb250cm9sIGFzIElBdWRpb1Nlc3Npb25Db250cm9sMjsKICAgICAgICBJU2ltcGxlQXVkaW9Wb2x1bWUgdm9sdW1lID0gY29udHJvbCBhcyBJU2ltcGxlQXVkaW9Wb2x1bWU7CiAgICAgICAgaWYgKGNvbnRyb2wyID09IG51bGwgfHwgdm9sdW1lID09IG51bGwpIGNvbnRpbnVlOwoKICAgICAgICB1aW50IHBpZFJhdyA9IDA7CiAgICAgICAgdHJ5IHsgY29udHJvbDIuR2V0UHJvY2Vzc0lkKG91dCBwaWRSYXcpOyB9IGNhdGNoIHsgfQogICAgICAgIGlmICh1bmNoZWNrZWQoKGludClwaWRSYXcpICE9IHBpZCkgY29udGludWU7CiAgICAgICAgdm9sdW1lLlNldE11dGUobXV0ZSwgcmVmIGNvbnRleHQpOwogICAgICAgIGNoYW5nZWQrKzsKICAgICAgfQoKICAgICAgaWYgKGNoYW5nZWQgPD0gMCkgewogICAgICAgIG1lc3NhZ2UgPSAiS2VpbmUgU2Vzc2lvbiBmdWVyIHBpZCBnZWZ1bmRlbiI7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIG1lc3NhZ2UgPSAiT0siOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBwdWJsaWMgc3RhdGljIGJvb2wgU2VuZFBsYXlQYXVzZShpbnQgcGlkLCBvdXQgc3RyaW5nIG1lc3NhZ2UpIHsKICAgICAgbWVzc2FnZSA9ICIiOwogICAgICBJbnRQdHIgdGFyZ2V0V2luZG93ID0gSW50UHRyLlplcm87CgogICAgICBpZiAocGlkID4gMCkgewogICAgICAgIHRyeSB7CiAgICAgICAgICBQcm9jZXNzIHByb2Nlc3MgPSBQcm9jZXNzLkdldFByb2Nlc3NCeUlkKHBpZCk7CiAgICAgICAgICB0YXJnZXRXaW5kb3cgPSBwcm9jZXNzLk1haW5XaW5kb3dIYW5kbGU7CiAgICAgICAgfSBjYXRjaCB7IH0KICAgICAgfQoKICAgICAgaWYgKHRhcmdldFdpbmRvdyAhPSBJbnRQdHIuWmVybykgewogICAgICAgIEludFB0ciBsUGFyYW0gPSBuZXcgSW50UHRyKEFQUENPTU1BTkRfTUVESUFfUExBWV9QQVVTRSA8PCAxNik7CiAgICAgICAgYm9vbCBwb3N0ZWQgPSBQb3N0TWVzc2FnZSh0YXJnZXRXaW5kb3csIFdNX0FQUENPTU1BTkQsIHRhcmdldFdpbmRvdywgbFBhcmFtKTsKICAgICAgICBpZiAocG9zdGVkKSB7CiAgICAgICAgICBtZXNzYWdlID0gIkFQUENPTU1BTkQgZ2VzZW5kZXQiOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBGYWxsYmFjayB0byBnbG9iYWwgbWVkaWEga2V5IChhY3RpdmUgbWVkaWEgc2Vzc2lvbikKICAgICAga2V5YmRfZXZlbnQoVktfTUVESUFfUExBWV9QQVVTRSwgMCwgMCwgMCk7CiAgICAgIGtleWJkX2V2ZW50KFZLX01FRElBX1BMQVlfUEFVU0UsIDAsIEtFWUVWRU5URl9LRVlVUCwgMCk7CiAgICAgIG1lc3NhZ2UgPSAiR2xvYmFsZXMgTWVkaWEgUGxheS9QYXVzZSBnZXNlbmRldCI7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KfQo='))
  Add-Type -Language CSharp -TypeDefinition $code
}

$action = [string]$args[0]
$targetPid = if ($args.Length -gt 1) { [int]$args[1] } else { 0 }
$value = if ($args.Length -gt 2) { [double]$args[2] } else { 0.0 }
$flag = if ($args.Length -gt 3) { [string]$args[3] } else { '' }

if ($action -eq 'snapshot') {
  $sessions = @([StreamDeckAudio.CoreAudioBridge]::ListSessions())
  $spotify = $sessions | Where-Object { [string]$_.ProcessName -match '(?i)spotify' } | Select-Object -First 1
  [pscustomobject]@{
    ok = $true
    sessions = $sessions
    spotify = $spotify
  } | ConvertTo-Json -Depth 8 -Compress
  exit 0
}

if ($action -eq 'setVolume') {
  $msg = ''
  $ok = [StreamDeckAudio.CoreAudioBridge]::SetVolume($targetPid, [float]([Math]::Max(0, [Math]::Min(100, $value)) / 100.0), [ref]$msg)
  [pscustomobject]@{
    ok = [bool]$ok
    message = [string]$msg
    pid = $targetPid
    volumePercent = [Math]::Round([Math]::Max(0, [Math]::Min(100, $value)), 1)
  } | ConvertTo-Json -Depth 8 -Compress
  exit 0
}

if ($action -eq 'setMute') {
  $mute = $false
  if ([string]$flag -match '^(1|true|yes|on)$') { $mute = $true }
  $msg = ''
  $ok = [StreamDeckAudio.CoreAudioBridge]::SetMute($targetPid, [bool]$mute, [ref]$msg)
  [pscustomobject]@{
    ok = [bool]$ok
    message = [string]$msg
    pid = $targetPid
    muted = [bool]$mute
  } | ConvertTo-Json -Depth 8 -Compress
  exit 0
}

if ($action -eq 'playPause') {
  $msg = ''
  $ok = [StreamDeckAudio.CoreAudioBridge]::SendPlayPause($targetPid, [ref]$msg)
  [pscustomobject]@{
    ok = [bool]$ok
    message = [string]$msg
    pid = $targetPid
  } | ConvertTo-Json -Depth 8 -Compress
  exit 0
}

throw "unknown audio action: $action"
