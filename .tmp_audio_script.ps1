YAp1c2luZyBTeXN0ZW07CnVzaW5nIFN5c3RlbS5Db2xsZWN0aW9ucy5HZW5lcmljOwp1c2luZyBTeXN0ZW0uRGlhZ25vc3RpY3M7CnVzaW5nIFN5c3RlbS5SdW50aW1lLkludGVyb3BTZXJ2aWNlczsKCm5hbWVzcGFjZSBTdHJlYW1EZWNrQXVkaW8gewogIHB1YmxpYyBlbnVtIEVEYXRhRmxvdyB7IGVSZW5kZXIgPSAwLCBlQ2FwdHVyZSA9IDEsIGVBbGwgPSAyIH0KICBwdWJsaWMgZW51bSBFUm9sZSB7IGVDb25zb2xlID0gMCwgZU11bHRpbWVkaWEgPSAxLCBlQ29tbXVuaWNhdGlvbnMgPSAyIH0KICBwdWJsaWMgZW51bSBBdWRpb1Nlc3Npb25TdGF0ZSB7IEluYWN0aXZlID0gMCwgQWN0aXZlID0gMSwgRXhwaXJlZCA9IDIgfQoKICBbR3VpZCgiQTk1NjY0RDItOTYxNC00RjM1LUE3NDYtREU4REI2MzYxN0U2IiksIEludGVyZmFjZVR5cGUoQ29tSW50ZXJmYWNlVHlwZS5JbnRlcmZhY2VJc0lVbmtub3duKV0KICBpbnRlcmZhY2UgSU1NRGV2aWNlRW51bWVyYXRvciB7CiAgICBpbnQgTm90SW1wbDEoKTsKICAgIGludCBHZXREZWZhdWx0QXVkaW9FbmRwb2ludChFRGF0YUZsb3cgZGF0YUZsb3csIEVSb2xlIHJvbGUsIG91dCBJTU1EZXZpY2UgcHBEZXZpY2UpOwogIH0KCiAgW0d1aWQoIkQ2NjYwNjNGLTE1ODctNEU0My04MUYxLUI5NDhFODA3MzYzRiIpLCBJbnRlcmZhY2VUeXBlKENvbUludGVyZmFjZVR5cGUuSW50ZXJmYWNlSXNJVW5rbm93bildCiAgaW50ZXJmYWNlIElNTURldmljZSB7CiAgICBpbnQgQWN0aXZhdGUocmVmIEd1aWQgaWlkLCBpbnQgZHdDbHNDdHgsIEludFB0ciBwQWN0aXZhdGlvblBhcmFtcywgW01hcnNoYWxBcyhVbm1hbmFnZWRUeXBlLklVbmtub3duKV0gb3V0IG9iamVjdCBwcEludGVyZmFjZSk7CiAgfQoKICBbR3VpZCgiNzdBQTk5QTAtMUJENi00ODRGLThCQzctMkM2NTRDOUE5QjZGIiksIEludGVyZmFjZVR5cGUoQ29tSW50ZXJmYWNlVHlwZS5JbnRlcmZhY2VJc0lVbmtub3duKV0KICBpbnRlcmZhY2UgSUF1ZGlvU2Vzc2lvbk1hbmFnZXIyIHsKICAgIGludCBOb3RJbXBsMSgpOwogICAgaW50IE5vdEltcGwyKCk7CiAgICBpbnQgR2V0U2Vzc2lvbkVudW1lcmF0b3Iob3V0IElBdWRpb1Nlc3Npb25FbnVtZXJhdG9yIFNlc3Npb25FbnVtKTsKICB9CgogIFtHdWlkKCJFMkY1QkIxMS0wNTcwLTQwQ0EtQUNERC0zQUEwMTI3N0RFRTgiKSwgSW50ZXJmYWNlVHlwZShDb21JbnRlcmZhY2VUeXBlLkludGVyZmFjZUlzSVVua25vd24pXQogIGludGVyZmFjZSBJQXVkaW9TZXNzaW9uRW51bWVyYXRvciB7CiAgICBpbnQgR2V0Q291bnQob3V0IGludCBTZXNzaW9uQ291bnQpOwogICAgaW50IEdldFNlc3Npb24oaW50IFNlc3Npb25Db3VudCwgb3V0IElBdWRpb1Nlc3Npb25Db250cm9sIFNlc3Npb24pOwogIH0KCiAgW0d1aWQoImJmYTk3MWYxLTRkNWUtNDBiYi05MzVlLTk2NzAzOWJmYmVlNCIpLCBJbnRlcmZhY2VUeXBlKENvbUludGVyZmFjZVR5cGUuSW50ZXJmYWNlSXNJVW5rbm93bildCiAgaW50ZXJmYWNlIElBdWRpb1Nlc3Npb25Db250cm9sIHsKICAgIGludCBHZXRTdGF0ZShvdXQgQXVkaW9TZXNzaW9uU3RhdGUgcFJldFZhbCk7CiAgICBpbnQgR2V0RGlzcGxheU5hbWUoW01hcnNoYWxBcyhVbm1hbmFnZWRUeXBlLkxQV1N0cildIG91dCBzdHJpbmcgcFJldFZhbCk7CiAgICBpbnQgU2V0RGlzcGxheU5hbWUoW01hcnNoYWxBcyhVbm1hbmFnZWRUeXBlLkxQV1N0cildIHN0cmluZyBWYWx1ZSwgcmVmIEd1aWQgRXZlbnRDb250ZXh0KTsKICAgIGludCBHZXRJY29uUGF0aChbTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuTFBXU3RyKV0gb3V0IHN0cmluZyBwUmV0VmFsKTsKICAgIGludCBTZXRJY29uUGF0aChbTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuTFBXU3RyKV0gc3RyaW5nIFZhbHVlLCByZWYgR3VpZCBFdmVudENvbnRleHQpOwogICAgaW50IEdldEdyb3VwaW5nUGFyYW0ob3V0IEd1aWQgcFJldFZhbCk7CiAgICBpbnQgU2V0R3JvdXBpbmdQYXJhbShyZWYgR3VpZCBPdmVycmlkZSwgcmVmIEd1aWQgRXZlbnRDb250ZXh0KTsKICAgIGludCBSZWdpc3RlckF1ZGlvU2Vzc2lvbk5vdGlmaWNhdGlvbihJbnRQdHIgTmV3Tm90aWZpY2F0aW9ucyk7CiAgICBpbnQgVW5yZWdpc3RlckF1ZGlvU2Vzc2lvbk5vdGlmaWNhdGlvbihJbnRQdHIgTmV3Tm90aWZpY2F0aW9ucyk7CiAgfQoKICBbR3VpZCgiYmZiN2ZmODgtNzIzOS00ZmM5LThmYTItMDdjOTUwYmU5YzZkIiksIEludGVyZmFjZVR5cGUoQ29tSW50ZXJmYWNlVHlwZS5JbnRlcmZhY2VJc0lVbmtub3duKV0KICBpbnRlcmZhY2UgSUF1ZGlvU2Vzc2lvbkNvbnRyb2wyIHsKICAgIGludCBHZXRTdGF0ZShvdXQgQXVkaW9TZXNzaW9uU3RhdGUgcFJldFZhbCk7CiAgICBpbnQgR2V0RGlzcGxheU5hbWUoW01hcnNoYWxBcyhVbm1hbmFnZWRUeXBlLkxQV1N0cildIG91dCBzdHJpbmcgcFJldFZhbCk7CiAgICBpbnQgU2V0RGlzcGxheU5hbWUoW01hcnNoYWxBcyhVbm1hbmFnZWRUeXBlLkxQV1N0cildIHN0cmluZyBWYWx1ZSwgcmVmIEd1aWQgRXZlbnRDb250ZXh0KTsKICAgIGludCBHZXRJY29uUGF0aChbTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuTFBXU3RyKV0gb3V0IHN0cmluZyBwUmV0VmFsKTsKICAgIGludCBTZXRJY29uUGF0aChbTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuTFBXU3RyKV0gc3RyaW5nIFZhbHVlLCByZWYgR3VpZCBFdmVudENvbnRleHQpOwogICAgaW50IEdldEdyb3VwaW5nUGFyYW0ob3V0IEd1aWQgcFJldFZhbCk7CiAgICBpbnQgU2V0R3JvdXBpbmdQYXJhbShyZWYgR3VpZCBPdmVycmlkZSwgcmVmIEd1aWQgRXZlbnRDb250ZXh0KTsKICAgIGludCBSZWdpc3RlckF1ZGlvU2Vzc2lvbk5vdGlmaWNhdGlvbihJbnRQdHIgTmV3Tm90aWZpY2F0aW9ucyk7CiAgICBpbnQgVW5yZWdpc3RlckF1ZGlvU2Vzc2lvbk5vdGlmaWNhdGlvbihJbnRQdHIgTmV3Tm90aWZpY2F0aW9ucyk7CiAgICBpbnQgR2V0U2Vzc2lvbklkZW50aWZpZXIoW01hcnNoYWxBcyhVbm1hbmFnZWRUeXBlLkxQV1N0cildIG91dCBzdHJpbmcgcFJldFZhbCk7CiAgICBpbnQgR2V0U2Vzc2lvbkluc3RhbmNlSWRlbnRpZmllcihbTWFyc2hhbEFzKFVubWFuYWdlZFR5cGUuTFBXU3RyKV0gb3V0IHN0cmluZyBwUmV0VmFsKTsKICAgIGludCBHZXRQcm9jZXNzSWQob3V0IHVpbnQgcFJldFZhbCk7CiAgICBpbnQgSXNTeXN0ZW1Tb3VuZHNTZXNzaW9uKCk7CiAgICBpbnQgU2V0RHVja2luZ1ByZWZlcmVuY2UoYm9vbCBvcHRPdXQpOwogIH0KCiAgW0d1aWQoIjg3Q0U1NDk4LTY4RDYtNDRFNS05MjE1LTZEQTQ3RUY4ODNEOCIpLCBJbnRlcmZhY2VUeXBlKENvbUludGVyZmFjZVR5cGUuSW50ZXJmYWNlSXNJVW5rbm93bildCiAgaW50ZXJmYWNlIElTaW1wbGVBdWRpb1ZvbHVtZSB7CiAgICBpbnQgU2V0TWFzdGVyVm9sdW1lKGZsb2F0IGZMZXZlbCwgcmVmIEd1aWQgRXZlbnRDb250ZXh0KTsKICAgIGludCBHZXRNYXN0ZXJWb2x1bWUob3V0IGZsb2F0IHBmTGV2ZWwpOwogICAgaW50IFNldE11dGUoYm9vbCBiTXV0ZSwgcmVmIEd1aWQgRXZlbnRDb250ZXh0KTsKICAgIGludCBHZXRNdXRlKG91dCBib29sIHBiTXV0ZSk7CiAgfQoKICBbQ29tSW1wb3J0LCBHdWlkKCJCQ0RFMDM5NS1FNTJGLTQ2N0MtOEUzRC1DNDU3OTI5MTY5MkUiKV0KICBjbGFzcyBNTURldmljZUVudW1lcmF0b3JDb21PYmplY3QgeyB9CgogIHB1YmxpYyBzZWFsZWQgY2xhc3MgU2Vzc2lvblNuYXBzaG90IHsKICAgIHB1YmxpYyBpbnQgUGlkIHsgZ2V0OyBzZXQ7IH0KICAgIHB1YmxpYyBzdHJpbmcgUHJvY2Vzc05hbWUgeyBnZXQ7IHNldDsgfQogICAgcHVibGljIHN0cmluZyBEaXNwbGF5TmFtZSB7IGdldDsgc2V0OyB9CiAgICBwdWJsaWMgc3RyaW5nIFNlc3Npb25JZGVudGlmaWVyIHsgZ2V0OyBzZXQ7IH0KICAgIHB1YmxpYyBzdHJpbmcgU3RhdGUgeyBnZXQ7IHNldDsgfQogICAgcHVibGljIGRvdWJsZSBWb2x1bWVQZXJjZW50IHsgZ2V0OyBzZXQ7IH0KICAgIHB1YmxpYyBib29sIE11dGVkIHsgZ2V0OyBzZXQ7IH0KICAgIHB1YmxpYyBib29sIEhhc1dpbmRvdyB7IGdldDsgc2V0OyB9CiAgfQoKICBwdWJsaWMgc3RhdGljIGNsYXNzIENvcmVBdWRpb0JyaWRnZSB7CiAgICBjb25zdCBpbnQgQ0xTQ1RYX0FMTCA9IDIzOwogICAgY29uc3QgdWludCBXTV9BUFBDT01NQU5EID0gMHgwMzE5OwogICAgY29uc3QgaW50IEFQUENPTU1BTkRfTUVESUFfUExBWV9QQVVTRSA9IDE0OwogICAgY29uc3QgYnl0ZSBWS19NRURJQV9QTEFZX1BBVVNFID0gMHhCMzsKICAgIGNvbnN0IGludCBLRVlFVkVOVEZfS0VZVVAgPSAweDAwMDI7CgogICAgW0RsbEltcG9ydCgidXNlcjMyLmRsbCIsIFNldExhc3RFcnJvciA9IHRydWUpXQogICAgc3RhdGljIGV4dGVybiBib29sIFBvc3RNZXNzYWdlKEludFB0ciBoV25kLCB1aW50IG1zZywgSW50UHRyIHdQYXJhbSwgSW50UHRyIGxQYXJhbSk7CgogICAgW0RsbEltcG9ydCgidXNlcjMyLmRsbCIpXQogICAgc3RhdGljIGV4dGVybiB2b2lkIGtleWJkX2V2ZW50KGJ5dGUgYlZrLCBieXRlIGJTY2FuLCBpbnQgZHdGbGFncywgaW50IGR3RXh0cmFJbmZvKTsKCiAgICBzdGF0aWMgSUF1ZGlvU2Vzc2lvbkVudW1lcmF0b3IgQ3JlYXRlU2Vzc2lvbkVudW1lcmF0b3IoKSB7CiAgICAgIElNTURldmljZUVudW1lcmF0b3IgZGV2aWNlRW51bWVyYXRvciA9IG5ldyBNTURldmljZUVudW1lcmF0b3JDb21PYmplY3QoKSBhcyBJTU1EZXZpY2VFbnVtZXJhdG9yOwogICAgICBpZiAoZGV2aWNlRW51bWVyYXRvciA9PSBudWxsKSB0aHJvdyBuZXcgSW52YWxpZE9wZXJhdGlvbkV4Y2VwdGlvbigiSU1NRGV2aWNlRW51bWVyYXRvciB1bmF2YWlsYWJsZSIpOwoKICAgICAgSU1NRGV2aWNlIGRldmljZTsKICAgICAgTWFyc2hhbC5UaHJvd0V4Y2VwdGlvbkZvckhSKGRldmljZUVudW1lcmF0b3IuR2V0RGVmYXVsdEF1ZGlvRW5kcG9pbnQoRURhdGFGbG93LmVSZW5kZXIsIEVSb2xlLmVNdWx0aW1lZGlhLCBvdXQgZGV2aWNlKSk7CiAgICAgIGlmIChkZXZpY2UgPT0gbnVsbCkgdGhyb3cgbmV3IEludmFsaWRPcGVyYXRpb25FeGNlcHRpb24oIkRlZmF1bHQgYXVkaW8gZW5kcG9pbnQgdW5hdmFpbGFibGUiKTsKCiAgICAgIG9iamVjdCBtYW5hZ2VyT2JqOwogICAgICBHdWlkIGlpZCA9IHR5cGVvZihJQXVkaW9TZXNzaW9uTWFuYWdlcjIpLkdVSUQ7CiAgICAgIE1hcnNoYWwuVGhyb3dFeGNlcHRpb25Gb3JIUihkZXZpY2UuQWN0aXZhdGUocmVmIGlpZCwgQ0xTQ1RYX0FMTCwgSW50UHRyLlplcm8sIG91dCBtYW5hZ2VyT2JqKSk7CiAgICAgIElBdWRpb1Nlc3Npb25NYW5hZ2VyMiBtYW5hZ2VyID0gbWFuYWdlck9iaiBhcyBJQXVkaW9TZXNzaW9uTWFuYWdlcjI7CiAgICAgIGlmIChtYW5hZ2VyID09IG51bGwpIHRocm93IG5ldyBJbnZhbGlkT3BlcmF0aW9uRXhjZXB0aW9uKCJJQXVkaW9TZXNzaW9uTWFuYWdlcjIgdW5hdmFpbGFibGUiKTsKCiAgICAgIElBdWRpb1Nlc3Npb25FbnVtZXJhdG9yIGVudW1lcmF0b3I7CiAgICAgIE1hcnNoYWwuVGhyb3dFeGNlcHRpb25Gb3JIUihtYW5hZ2VyLkdldFNlc3Npb25FbnVtZXJhdG9yKG91dCBlbnVtZXJhdG9yKSk7CiAgICAgIHJldHVybiBlbnVtZXJhdG9yOwogICAgfQoKICAgIHB1YmxpYyBzdGF0aWMgTGlzdDxTZXNzaW9uU25hcHNob3Q+IExpc3RTZXNzaW9ucygpIHsKICAgICAgTGlzdDxTZXNzaW9uU25hcHNob3Q+IHJlc3VsdCA9IG5ldyBMaXN0PFNlc3Npb25TbmFwc2hvdD4oKTsKICAgICAgSUF1ZGlvU2Vzc2lvbkVudW1lcmF0b3IgZW51bWVyYXRvciA9IENyZWF0ZVNlc3Npb25FbnVtZXJhdG9yKCk7CiAgICAgIGludCBjb3VudCA9IDA7CiAgICAgIE1hcnNoYWwuVGhyb3dFeGNlcHRpb25Gb3JIUihlbnVtZXJhdG9yLkdldENvdW50KG91dCBjb3VudCkpOwoKICAgICAgZm9yIChpbnQgaSA9IDA7IGkgPCBjb3VudDsgaSsrKSB7CiAgICAgICAgSUF1ZGlvU2Vzc2lvbkNvbnRyb2wgY29udHJvbDsKICAgICAgICBNYXJzaGFsLlRocm93RXhjZXB0aW9uRm9ySFIoZW51bWVyYXRvci5HZXRTZXNzaW9uKGksIG91dCBjb250cm9sKSk7CiAgICAgICAgaWYgKGNvbnRyb2wgPT0gbnVsbCkgY29udGludWU7CgogICAgICAgIElBdWRpb1Nlc3Npb25Db250cm9sMiBjb250cm9sMiA9IGNvbnRyb2wgYXMgSUF1ZGlvU2Vzc2lvbkNvbnRyb2wyOwogICAgICAgIElTaW1wbGVBdWRpb1ZvbHVtZSB2b2x1bWUgPSBjb250cm9sIGFzIElTaW1wbGVBdWRpb1ZvbHVtZTsKICAgICAgICBpZiAoY29udHJvbDIgPT0gbnVsbCB8fCB2b2x1bWUgPT0gbnVsbCkgY29udGludWU7CgogICAgICAgIEF1ZGlvU2Vzc2lvblN0YXRlIHN0YXRlID0gQXVkaW9TZXNzaW9uU3RhdGUuSW5hY3RpdmU7CiAgICAgICAgdHJ5IHsgY29udHJvbC5HZXRTdGF0ZShvdXQgc3RhdGUpOyB9IGNhdGNoIHsgfQoKICAgICAgICB1aW50IHBpZFJhdyA9IDA7CiAgICAgICAgdHJ5IHsgY29udHJvbDIuR2V0UHJvY2Vzc0lkKG91dCBwaWRSYXcpOyB9IGNhdGNoIHsgfQogICAgICAgIGludCBwaWQgPSB1bmNoZWNrZWQoKGludClwaWRSYXcpOwoKICAgICAgICBzdHJpbmcgZGlzcGxheU5hbWUgPSAiIjsKICAgICAgICB0cnkgeyBjb250cm9sLkdldERpc3BsYXlOYW1lKG91dCBkaXNwbGF5TmFtZSk7IH0gY2F0Y2ggeyBkaXNwbGF5TmFtZSA9ICIiOyB9CgogICAgICAgIHN0cmluZyBzZXNzaW9uSWRlbnRpZmllciA9ICIiOwogICAgICAgIHRyeSB7IGNvbnRyb2wyLkdldFNlc3Npb25JZGVudGlmaWVyKG91dCBzZXNzaW9uSWRlbnRpZmllcik7IH0gY2F0Y2ggeyBzZXNzaW9uSWRlbnRpZmllciA9ICIiOyB9CgogICAgICAgIGZsb2F0IHZvbHVtZVJhdyA9IDBmOwogICAgICAgIHRyeSB7IHZvbHVtZS5HZXRNYXN0ZXJWb2x1bWUob3V0IHZvbHVtZVJhdyk7IH0gY2F0Y2ggeyB9CiAgICAgICAgYm9vbCBtdXRlZCA9IGZhbHNlOwogICAgICAgIHRyeSB7IHZvbHVtZS5HZXRNdXRlKG91dCBtdXRlZCk7IH0gY2F0Y2ggeyB9CgogICAgICAgIHN0cmluZyBwcm9jZXNzTmFtZSA9ICIiOwogICAgICAgIGJvb2wgaGFzV2luZG93ID0gZmFsc2U7CiAgICAgICAgaWYgKHBpZCA+IDApIHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIFByb2Nlc3MgcHJvY2VzcyA9IFByb2Nlc3MuR2V0UHJvY2Vzc0J5SWQocGlkKTsKICAgICAgICAgICAgcHJvY2Vzc05hbWUgPSBwcm9jZXNzLlByb2Nlc3NOYW1lID8/ICIiOwogICAgICAgICAgICBoYXNXaW5kb3cgPSBwcm9jZXNzLk1haW5XaW5kb3dIYW5kbGUgIT0gSW50UHRyLlplcm87CiAgICAgICAgICB9IGNhdGNoIHsKICAgICAgICAgICAgcHJvY2Vzc05hbWUgPSAiIjsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHBpZCA9PSAwKSB7CiAgICAgICAgICBwcm9jZXNzTmFtZSA9ICJTeXN0ZW0iOwogICAgICAgIH0KCiAgICAgICAgcmVzdWx0LkFkZChuZXcgU2Vzc2lvblNuYXBzaG90IHsKICAgICAgICAgIFBpZCA9IHBpZCwKICAgICAgICAgIFByb2Nlc3NOYW1lID0gcHJvY2Vzc05hbWUsCiAgICAgICAgICBEaXNwbGF5TmFtZSA9IGRpc3BsYXlOYW1lID8/ICIiLAogICAgICAgICAgU2Vzc2lvbklkZW50aWZpZXIgPSBzZXNzaW9uSWRlbnRpZmllciA/PyAiIiwKICAgICAgICAgIFN0YXRlID0gc3RhdGUuVG9TdHJpbmcoKSwKICAgICAgICAgIFZvbHVtZVBlcmNlbnQgPSBNYXRoLlJvdW5kKE1hdGguTWF4KDAuMCwgTWF0aC5NaW4oMS4wLCB2b2x1bWVSYXcpKSAqIDEwMC4wLCAxKSwKICAgICAgICAgIE11dGVkID0gbXV0ZWQsCiAgICAgICAgICBIYXNXaW5kb3cgPSBoYXNXaW5kb3cKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KCiAgICBwdWJsaWMgc3RhdGljIGJvb2wgU2V0Vm9sdW1lKGludCBwaWQsIGZsb2F0IGxldmVsLCBvdXQgc3RyaW5nIG1lc3NhZ2UpIHsKICAgICAgbWVzc2FnZSA9ICIiOwogICAgICBpZiAocGlkIDw9IDApIHsKICAgICAgICBtZXNzYWdlID0gInBpZCBmZWhsdCI7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICBmbG9hdCBjbGFtcGVkID0gTWF0aC5NYXgoMGYsIE1hdGguTWluKDFmLCBsZXZlbCkpOwogICAgICBHdWlkIGNvbnRleHQgPSBHdWlkLkVtcHR5OwogICAgICBpbnQgY2hhbmdlZCA9IDA7CiAgICAgIElBdWRpb1Nlc3Npb25FbnVtZXJhdG9yIGVudW1lcmF0b3IgPSBDcmVhdGVTZXNzaW9uRW51bWVyYXRvcigpOwogICAgICBpbnQgY291bnQgPSAwOwogICAgICBNYXJzaGFsLlRocm93RXhjZXB0aW9uRm9ySFIoZW51bWVyYXRvci5HZXRDb3VudChvdXQgY291bnQpKTsKCiAgICAgIGZvciAoaW50IGkgPSAwOyBpIDwgY291bnQ7IGkrKykgewogICAgICAgIElBdWRpb1Nlc3Npb25Db250cm9sIGNvbnRyb2w7CiAgICAgICAgTWFyc2hhbC5UaHJvd0V4Y2VwdGlvbkZvckhSKGVudW1lcmF0b3IuR2V0U2Vzc2lvbihpLCBvdXQgY29udHJvbCkpOwogICAgICAgIGlmIChjb250cm9sID09IG51bGwpIGNvbnRpbnVlOwoKICAgICAgICBJQXVkaW9TZXNzaW9uQ29udHJvbDIgY29udHJvbDIgPSBjb250cm9sIGFzIElBdWRpb1Nlc3Npb25Db250cm9sMjsKICAgICAgICBJU2ltcGxlQXVkaW9Wb2x1bWUgdm9sdW1lID0gY29udHJvbCBhcyBJU2ltcGxlQXVkaW9Wb2x1bWU7CiAgICAgICAgaWYgKGNvbnRyb2wyID09IG51bGwgfHwgdm9sdW1lID09IG51bGwpIGNvbnRpbnVlOwoKICAgICAgICB1aW50IHBpZFJhdyA9IDA7CiAgICAgICAgdHJ5IHsgY29udHJvbDIuR2V0UHJvY2Vzc0lkKG91dCBwaWRSYXcpOyB9IGNhdGNoIHsgfQogICAgICAgIGlmICh1bmNoZWNrZWQoKGludClwaWRSYXcpICE9IHBpZCkgY29udGludWU7CiAgICAgICAgdm9sdW1lLlNldE1hc3RlclZvbHVtZShjbGFtcGVkLCByZWYgY29udGV4dCk7CiAgICAgICAgY2hhbmdlZCsrOwogICAgICB9CgogICAgICBpZiAoY2hhbmdlZCA8PSAwKSB7CiAgICAgICAgbWVzc2FnZSA9ICJLZWluZSBTZXNzaW9uIGZ1ZXIgcGlkIGdlZnVuZGVuIjsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgbWVzc2FnZSA9ICJPSyI7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIHB1YmxpYyBzdGF0aWMgYm9vbCBTZXRNdXRlKGludCBwaWQsIGJvb2wgbXV0ZSwgb3V0IHN0cmluZyBtZXNzYWdlKSB7CiAgICAgIG1lc3NhZ2UgPSAiIjsKICAgICAgaWYgKHBpZCA8PSAwKSB7CiAgICAgICAgbWVzc2FnZSA9ICJwaWQgZmVobHQiOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgR3VpZCBjb250ZXh0ID0gR3VpZC5FbXB0eTsKICAgICAgaW50IGNoYW5nZWQgPSAwOwogICAgICBJQXVkaW9TZXNzaW9uRW51bWVyYXRvciBlbnVtZXJhdG9yID0gQ3JlYXRlU2Vzc2lvbkVudW1lcmF0b3IoKTsKICAgICAgaW50IGNvdW50ID0gMDsKICAgICAgTWFyc2hhbC5UaHJvd0V4Y2VwdGlvbkZvckhSKGVudW1lcmF0b3IuR2V0Q291bnQob3V0IGNvdW50KSk7CgogICAgICBmb3IgKGludCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHsKICAgICAgICBJQXVkaW9TZXNzaW9uQ29udHJvbCBjb250cm9sOwogICAgICAgIE1hcnNoYWwuVGhyb3dFeGNlcHRpb25Gb3JIUihlbnVtZXJhdG9yLkdldFNlc3Npb24oaSwgb3V0IGNvbnRyb2wpKTsKICAgICAgICBpZiAoY29udHJvbCA9PSBudWxsKSBjb250aW51ZTsKCiAgICAgICAgSUF1ZGlvU2Vzc2lvbkNvbnRyb2wyIGNvbnRyb2wyID0gY29udHJvbCBhcyBJQXVkaW9TZXNzaW9uQ29udHJvbDI7CiAgICAgICAgSVNpbXBsZUF1ZGlvVm9sdW1lIHZvbHVtZSA9IGNvbnRyb2wgYXMgSVNpbXBsZUF1ZGlvVm9sdW1lOwogICAgICAgIGlmIChjb250cm9sMiA9PSBudWxsIHx8IHZvbHVtZSA9PSBudWxsKSBjb250aW51ZTsKCiAgICAgICAgdWludCBwaWRSYXcgPSAwOwogICAgICAgIHRyeSB7IGNvbnRyb2wyLkdldFByb2Nlc3NJZChvdXQgcGlkUmF3KTsgfSBjYXRjaCB7IH0KICAgICAgICBpZiAodW5jaGVja2VkKChpbnQpcGlkUmF3KSAhPSBwaWQpIGNvbnRpbnVlOwogICAgICAgIHZvbHVtZS5TZXRNdXRlKG11dGUsIHJlZiBjb250ZXh0KTsKICAgICAgICBjaGFuZ2VkKys7CiAgICAgIH0KCiAgICAgIGlmIChjaGFuZ2VkIDw9IDApIHsKICAgICAgICBtZXNzYWdlID0gIktlaW5lIFNlc3Npb24gZnVlciBwaWQgZ2VmdW5kZW4iOwogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICBtZXNzYWdlID0gIk9LIjsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgcHVibGljIHN0YXRpYyBib29sIFNlbmRQbGF5UGF1c2UoaW50IHBpZCwgb3V0IHN0cmluZyBtZXNzYWdlKSB7CiAgICAgIG1lc3NhZ2UgPSAiIjsKICAgICAgSW50UHRyIHRhcmdldFdpbmRvdyA9IEludFB0ci5aZXJvOwoKICAgICAgaWYgKHBpZCA+IDApIHsKICAgICAgICB0cnkgewogICAgICAgICAgUHJvY2VzcyBwcm9jZXNzID0gUHJvY2Vzcy5HZXRQcm9jZXNzQnlJZChwaWQpOwogICAgICAgICAgdGFyZ2V0V2luZG93ID0gcHJvY2Vzcy5NYWluV2luZG93SGFuZGxlOwogICAgICAgIH0gY2F0Y2ggeyB9CiAgICAgIH0KCiAgICAgIGlmICh0YXJnZXRXaW5kb3cgIT0gSW50UHRyLlplcm8pIHsKICAgICAgICBJbnRQdHIgbFBhcmFtID0gbmV3IEludFB0cihBUFBDT01NQU5EX01FRElBX1BMQVlfUEFVU0UgPDwgMTYpOwogICAgICAgIGJvb2wgcG9zdGVkID0gUG9zdE1lc3NhZ2UodGFyZ2V0V2luZG93LCBXTV9BUFBDT01NQU5ELCB0YXJnZXRXaW5kb3csIGxQYXJhbSk7CiAgICAgICAgaWYgKHBvc3RlZCkgewogICAgICAgICAgbWVzc2FnZSA9ICJBUFBDT01NQU5EIGdlc2VuZGV0IjsKICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gRmFsbGJhY2sgdG8gZ2xvYmFsIG1lZGlhIGtleSAoYWN0aXZlIG1lZGlhIHNlc3Npb24pCiAgICAgIGtleWJkX2V2ZW50KFZLX01FRElBX1BMQVlfUEFVU0UsIDAsIDAsIDApOwogICAgICBrZXliZF9ldmVudChWS19NRURJQV9QTEFZX1BBVVNFLCAwLCBLRVlFVkVOVEZfS0VZVVAsIDApOwogICAgICBtZXNzYWdlID0gIkdsb2JhbGVzIE1lZGlhIFBsYXkvUGF1c2UgZ2VzZW5kZXQiOwogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICB9Cn0KYA==`
$ErrorActionPreference = 'Stop'
Set-StrictMode -Version Latest

if (-not ("StreamDeckAudio.CoreAudioBridge" -as [type])) {
  $code = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String('${AUDIO_MIXER_BRIDGE_CSHARP_B64}'))
  Add-Type -Language CSharp -TypeDefinition $code
}

$action = [string]$args[0]
$pid = if ($args.Length -gt 1) { [int]$args[1] } else { 0 }
$value = if ($args.Length -gt 2) { [double]$args[2] } else { 0.0 }
$flag = if ($args.Length -gt 3) { [string]$args[3] } else { '' }

if ($action -eq 'snapshot') {
  $sessions = @([StreamDeckAudio.CoreAudioBridge]::ListSessions())
  $spotify = $sessions | Where-Object { [string]$_.ProcessName -match '(?i)spotify' } | Select-Object -First 1
  [pscustomobject]@{
    ok = $true
    sessions = $sessions
    spotify = $spotify
  } | ConvertTo-Json -Depth 8 -Compress
  exit 0
}

if ($action -eq 'setVolume') {
  $msg = ''
  $ok = [StreamDeckAudio.CoreAudioBridge]::SetVolume($pid, [float]([Math]::Max(0, [Math]::Min(100, $value)) / 100.0), [ref]$msg)
  [pscustomobject]@{
    ok = [bool]$ok
    message = [string]$msg
    pid = $pid
    volumePercent = [Math]::Round([Math]::Max(0, [Math]::Min(100, $value)), 1)
  } | ConvertTo-Json -Depth 8 -Compress
  exit 0
}

if ($action -eq 'setMute') {
  $mute = $false
  if ([string]$flag -match '^(1|true|yes|on)$') { $mute = $true }
  $msg = ''
  $ok = [StreamDeckAudio.CoreAudioBridge]::SetMute($pid, [bool]$mute, [ref]$msg)
  [pscustomobject]@{
    ok = [bool]$ok
    message = [string]$msg
    pid = $pid
    muted = [bool]$mute
  } | ConvertTo-Json -Depth 8 -Compress
  exit 0
}

if ($action -eq 'playPause') {
  $msg = ''
  $ok = [StreamDeckAudio.CoreAudioBridge]::SendPlayPause($pid, [ref]$msg)
  [pscustomobject]@{
    ok = [bool]$ok
    message = [string]$msg
    pid = $pid
  } | ConvertTo-Json -Depth 8 -Compress
  exit 0
}

throw "unknown audio action: $action"
`